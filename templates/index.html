<!DOCTYPE html>
<html lang="en" dir="ltr">

<head>
    <title>Data Visualization</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.1.3/css/bootstrap.min.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.3/umd/popper.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.1.3/js/bootstrap.min.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.7.3/Chart.min.js"></script>
</head>

<body class="pt-5"> <!-- pt-5 to add space between below navigation bar -->
  
  <!-- Header -->
    <nav class="navbar navbar-dark fixed-top bg-dark flex-md-nowrap p-0 shadow">
      <a class="navbar-brand col-sm-3 col-md-2 mr-0" href="#"> Query Visualization </a>
    </nav>

  <div class="container-fluid">

    <!-- Row 1 -->
    <div class="row mt-3">
      <div class="col">
        <div class="card">
          <div class="card-header"> Directed Acyclic Graph </div>
          <div class="card-block">
            <div id="dag"> </div>
          </div>
        </div>
      </div>
    </div>
  
    <!-- Row 2 -->
    <div class="row mt-3">
      <div class="col-sm-4">
        <!-- col will also work-->
        <div class="card">
          <div class="card-header"> Bar Chart</div>
          <div class="card-block"> <canvas id="barChart"></canvas> </div>
        </div>
      </div>
  
      <div class="col-sm-4">
        <div class="card">
          <div class="card-header"> Line Chart</div>
          <div class="card-block"> <canvas id="lineChart"></canvas> </div>
        </div>
      </div>
  
      <div class="col-sm-4">
        <div class="card">
          <div class="card-header"> Pie Chart</div>
          <div class="card-block"> <canvas id="pieChart"></canvas> </div>
        </div>
      </div>
    </div>
    
  </div>

  <p class="mt-5 mb-3 text-muted text-center">Â© 2018-2019</p>

  <!-- Footer -->
  <!-- https://getbootstrap.com/docs/4.0/components/navbar/ -->
  <!-- <nav class="navbar navbar-dark fixed-bottom bg-dark flex-md-nowrap p-0 shadow">
      <a class="navbar-brand col-sm-3 col-md-2 mr-0" href="#"> Query Visualization </a>
  </nav> -->
  

  <script src="https://d3js.org/d3.v4.min.js"></script>
  <script>

    var socket = new WebSocket("ws://localhost:4040/echo");

    socket.onopen = function () {
      socket.send("Connection created!!!");
    };

      var returnedBarChart = null, returnedLineChart = null, returnedPieChart = null;
      
      function createDAG() {

        // Fetch json data
        // Use https://d059d46c-898c-4ad8-bd3d-ec8d4c5c870d.mock.pstmn.io/dv (to get data from postman)
        // Use 'http://localhost:4040/api' (to get data from local server)

        fetch('/api') // '/api' or 'http://localhost:4040/api' will work
          .then(function (response) {
            return response.json();
          }).then(function (myJson) {

            var nodes = myJson.nodes;
            console.log(nodes);
            var links = myJson.links;
            console.log(links);

            function getNodeColor(node) {
              return node.level === 2 ? 'OrangeRed' : 'SpringGreen'
            }


            var width = window.innerWidth
            var height = window.innerHeight/2

            var svg = d3.select('#dag').append('svg')
            svg.attr('width', width).attr('height', height)

            // simulation setup with all forces
            var linkForce = d3
              .forceLink()
              .id(function (link) { return link.id })
              .strength(function (link) { return link.strength })

            var simulation = d3
              .forceSimulation()
              .force('link', linkForce)
              .force('charge', d3.forceManyBody().strength(-4500))
              .force('center', d3.forceCenter(width / 2, height / 2))

              var dragDrop = d3.drag().on('start', function (node) {
              node.fx = node.x
              node.fy = node.y
            }).on('drag', function (node) {
              simulation.alphaTarget(0.7).restart()
              node.fx = d3.event.x
              node.fy = d3.event.y
            }).on('end', function (node) {
              if (!d3.event.active) {
                simulation.alphaTarget(0)
              }
              node.fx = null
              node.fy = null
            })

            
            function selectNode(selectedNode) {
              console.log(selectedNode.data);
              console.log(returnedBarChart);

              if(returnedBarChart != null || returnedLineChart != null || returnedPieChart != null) {
                returnedBarChart.destroy();
                returnedLineChart.destroy();
                returnedPieChart.destroy();
              }

              var citiesArray = selectedNode.data
              var citiesNamesArray = []
              var citiesStudentArray = []
              
              for (var i = 0; i < citiesArray.length; i++) {
                var city = citiesArray[i];
                //console.log(city.name)
                citiesNamesArray.push(city.name)
                citiesStudentArray.push(city.count)

              }
              
              returnedBarChart = createChart(citiesNamesArray, citiesStudentArray, 'barChart', 'bar')
              returnedLineChart = createChart(citiesNamesArray, citiesStudentArray, 'lineChart', 'line')
              returnedPieChart = createChart(citiesNamesArray, citiesStudentArray, 'pieChart', 'pie')
            }

            function createChart(labelArray, dataArray, chartId, chartType) {
              let myChart = document.getElementById(chartId).getContext('2d')
              let massPopChart = new Chart(myChart, {
                type: chartType, //bar, pie, horizontalBar, line, doughnut, radar, polarArea
                data: {
                  labels: labelArray,
                  datasets: [{
                    label: 'Students',
                    data: dataArray,
                    //backgroundColor:'blue'
                    backgroundColor: ["rgb(255, 205, 86)","rgb(75, 192, 192)","rgb(54, 162, 235)","rgb(153, 102, 255)","rgb(201, 203, 207)"],
                    borderWidth: 4,
                    borderColor: 'gray',
                    hoverBorderWidth: 4,
                    hoverBorderColor: 'black'
                  }]
                },
                options: {}
              });
              return massPopChart;
            }

            svg = d3.select("svg")
            svg.append("svg:defs").append("svg:marker")
              .attr("id", "arrow")
              .attr("viewBox", "0 -5 10 10")
              .attr('refX', -50)//so that it comes towards the center.
              .attr("markerWidth", 5)
              .attr("markerHeight", 5)
              .attr("orient", "auto")
              .append("svg:path")
              .attr("d", "M0,-5L10,0L0,5");

            var linkElements = svg.selectAll("line.link")
              .data(links)
              .enter().append("path")//append path
              .attr("class", "link")
              .style("stroke", "#000")
              .attr('marker-start', (d) => "url(#arrow)")//attach the arrow from defs
              .style("stroke-width", 2);

            var nodeElements = svg.append("g")
              .attr("class", "nodes")
              .selectAll("circle")
              .data(nodes)
              .enter().append("circle")
              .attr("r", 10)
              .attr("fill", getNodeColor)
              .call(dragDrop)
              .on('click', selectNode)

            // var nodeElements = svg.append("g")
            //   .attr("class", "nodes")
            //   .selectAll("image")
            //   .data(nodes)
            //   .enter().append("svg:image")
            //   .attr('width', 20)
            //   .attr('height', 24)
            //   .attr("xlink:href", "https://mdn.mozillademos.org/files/6457/mdn_logo_only_color.png")
            //   .call(dragDrop)
            //   .on('click', selectNode)

            // var nodeElements = svg.append("g")
            //   .attr("class", "nodes")
            //   .selectAll("div")
            //   .data(nodes)
            //   .enter().append("div")
            //   //.attr("id", "barChart")
            //   .attr("style", "border:1px solid #000000;")
            //   .call(dragDrop)
            //   .on('click', selectNode)

              // var nodeElements = svg.append("g")
              // .attr("class", "nodes")
              // .selectAll("svg")
              // .data(nodes)
              // .enter().append("svg")
              // .attr("width", 10)
              // .attr("height", 10)
              // .style("background-color", "green")
              // .call(dragDrop)
              // .on('click', selectNode)

            // var canvasElements = nodeElements.append("canvas")
            //   .attr("id", "barChart")
            //   .attr("style", "height:40; width:40; border:1px solid #000000;")

            var textElements = svg.append("g")
              .attr("class", "texts")
              .selectAll("text")
              .data(nodes)
              .enter().append("text")
              .text(function (node) { return node.label })
              .attr("font-size", 15)
              .attr("dx", 15)
              .attr("dy", 4)

            simulation.nodes(nodes).on('tick', () => {
              nodeElements
                .attr('cx', function (node) { return node.x })
                .attr('cy', function (node) { return node.y })
              textElements
                .attr('x', function (node) { return node.x })
                .attr('y', function (node) { return node.y })
                linkElements
                .attr("d", (d) => "M" + d.source.x + "," + d.source.y + ", " + d.target.x + "," + d.target.y)
            })

            simulation.force("link").links(links)

          });
      };

    createDAG();
    socket.onmessage = function (e) {
      d3.select("#dag").select("svg").remove();
      createDAG()
    };

    //window.setTimeout(chart);
  </script>

</body>

</html>